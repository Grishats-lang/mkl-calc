<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes, maximum-scale=5">
    <title>Диаграмма Ганта Pro - Просмотр</title>
    
    <!-- Highcharts -->
    <script src="js/highcharts.js"></script>
    <script src="js/gantt.js"></script>
    <script src="js/exporting.js"></script>
    <script src="js/modules/export-data.js"></script>
    <script src="js/accessibility.js"></script>
    
<style>
    /* Переменные для удобства, если захочешь поменять оттенки */
    :root {
        --primary-blue: #0D47A1;
        --accent-teal: #00796B;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        /* Фон страницы: Градиент от Синего к Бирюзовому */
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
        min-height: 100vh;
        padding: 20px;
        /* Разрешаем зум на всей странице */
        touch-action: pan-x pan-y pinch-zoom;
    }

    .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 95vh;
        /* Разрешаем зум внутри контейнера */
        touch-action: pan-x pan-y pinch-zoom;
    }

    .header {
        /* Фон шапки: Тот же градиент для целостности */
        background: linear-gradient(135deg, var(--primary-blue) 0%, var(--accent-teal) 100%);
        color: white;
        padding: 20px;
        text-align: center;
        flex-shrink: 0;
    }

    .header h1 {
        font-size: 24px;
        margin-bottom: 2px;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header p {
        opacity: 0.9;
        font-size: 1em;
    }

    /* Легенда */
    .legend {
        display: flex;
        gap: 10px;
        font-size: 11px;
        justify-content: center;
        margin-top: 5px;
    }
    
    .legend-item { display: flex; align-items: center; gap: 4px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; }

    #ganttChart {
        flex-grow: 1;
        width: 100%;
        overflow: hidden;
        /* Разрешаем все жесты: pan и зум */
        touch-action: pan-x pan-y pinch-zoom;
        -webkit-overflow-scrolling: touch; /* Плавный скролл на iOS */
    }

    /* Лоадер (цвета тоже обновлены) */
    #loader {
        position: absolute;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        font-size: 14px;
        color: #666;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 10px;
    }

    .spinner {
        width: 30px; height: 30px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary-blue);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Стили для мобильных устройств */
    @media (max-width: 768px) {
        body {
            padding: 10px;
            touch-action: pan-x pan-y pinch-zoom;
        }
        
        .container {
            height: 98vh;
            border-radius: 15px;
            touch-action: pan-x pan-y pinch-zoom;
        }
        
        .header h1 {
            font-size: 18px;
        }
        
        .header p {
            font-size: 0.9em;
        }
        
        #ganttChart {
            touch-action: pan-x pan-y pinch-zoom;
        }
    }

    @media (max-width: 600px) {
        body { 
            padding: 5px; 
        }
        .header h1 { 
            font-size: 16px; 
        }
        .legend { 
            display: none; 
        }
        .container {
            height: 99vh;
            border-radius: 10px;
        }
    }

    /* Стили для устройств с touch-экраном */
    @media (hover: none) and (pointer: coarse) {
        #ganttChart {
            touch-action: pan-x pan-y pinch-zoom;
            cursor: grab;
        }
        
        #ganttChart:active {
            cursor: grabbing;
        }
    }

    /* Адаптация для очень маленьких экранов */
    @media (max-width: 480px) {
        .header {
            padding: 10px;
        }
        
        .header h1 {
            font-size: 14px;
        }
    }
</style>
</head>
<body>
    <div class="container">
         <!-- Диаграмма Ганта -->
        <div id="ganttChart"></div>
    </div>

    <script>
        let chartInstance = null;
        
        // Настройки по умолчанию (так как инпуты удалены)
        const config = {
            chartHeight: null, // null = авто-высота
            projectName: "Строительство здания MKL",
            startDate: new Date(), // Сегодня
            theme: 'light',
            primaryColor: '#667eea'
        };

        // Данные проекта
        let projectData = [
            {
                name: 'Подготовка проекта',
                id: 'phase_design',
                color: '#e0e0e0'
            },
            {
                name: 'Консультация и ТЗ',
                parent: 'phase_design',
                start: 0,
                end: 1,
                color: '#546E7A',
                completed: 0.15
            },
            {
                name: 'Разработка КМ/КМД',
                parent: 'phase_design',
                start: 1,
                end: 4,
                color: '#546E7A',
                dependency: 'task_prod'
            },
            {
                name: 'Производство и Снабжение',
                id: 'phase_supply',
                color: '#e0e0e0'
            },
            {
                id: 'task_prod',
                name: 'Изготовление конструкций',
                parent: 'phase_supply',
                start: 4,
                end: 14,
                color: '#0D47A1'
            },
            {
                name: 'Доставка на объект',
                parent: 'phase_supply',
                start: 14,
                end: 16,
                color: '#00796B',
                dependency: 'task_frame'
            },
            {
                name: 'Строительно-монтажные работы',
                id: 'phase_build',
                color: '#e0e0e0'
            },
            {
                id: 'task_frame',
                name: 'Монтаж металлокаркаса',
                parent: 'phase_build',
                start: 16,
                end: 26,
                color: '#EF6C00'
            },
            {
                name: 'Монтаж сэндвич-панелей',
                parent: 'phase_build',
                start: 26,
                end: 36,
                color: '#EF6C00'
            },
            {
                name: 'Установка ворот и окон',
                parent: 'phase_build',
                start: 36,
                end: 41,
                color: '#EF6C00',
                dependency: 'task_handover'
            },
            {
                id: 'task_handover',
                name: 'Сдача объекта',
                start: 43,
                end: 43,
                milestone: true,
                color: '#00796B'
            }
        ];

        function convertToGanttData() {
            const day = 1000 * 60 * 60 * 24;
            const startTimestamp = config.startDate.getTime();
            
            return projectData.map(task => {
                // Если есть start/end в днях, конвертируем в timestamp
                if (task.start !== undefined && task.end !== undefined) {
                    return {
                        ...task,
                        start: startTimestamp + (task.start * day),
                        end: startTimestamp + (task.end * day)
                    };
                }
                return task;
            });
        }

        function updateChart() {
            const ganttData = convertToGanttData();
            
            // Настройки стилей
            const backgroundColor = 'transparent';
            const textColor = '#212121';
            const gridColor = 'rgba(0,0,0,0.1)';

            chartInstance = Highcharts.ganttChart('ganttChart', {
                chart: {
                    // height: config.chartHeight, // Автоматическая высота
                    backgroundColor: backgroundColor,
                    style: { fontFamily: "'Segoe UI', sans-serif" },
                    // Включаем поддержку touch-событий для зума
                    zooming: {
                        type: 'x',
                        pinchType: 'x', // Разрешаем зум пальцами по оси X
                        resetButton: {
                            position: {
                                x: 10,
                                y: 10
                            }
                        }
                    },
                    // Оптимизация для touch-устройств
                    panning: {
                        enabled: true,
                        type: 'x'
                    },
                    pinchType: 'x', // Пинч-зум по оси X
                    options3d: {
                        enabled: false
                    },
                    // Увеличиваем чувствительность для touch
                    touch: {
                        enabled: true,
                        panSensitivity: 2
                    }
                },
                title: {
                    text: config.projectName,
                    style: { 
                        fontSize: '24px', 
                        fontWeight: 'bold', 
                        color: textColor 
                    }
                },
                xAxis: [{
                    currentDateIndicator: {
                        color: config.primaryColor,
                        dashStyle: 'ShortDot',
                        width: 3,
                        label: {
                            format: 'Сегодня',
                            style: { color: config.primaryColor, fontWeight: 'bold' }
                        }
                    },
                    grid: { 
                        borderWidth: 1, 
                        borderColor: gridColor 
                    },
                    // Настройки для touch-взаимодействия
                    minRange: 24 * 3600 * 1000, // Минимальный диапазон - 1 день
                    maxRange: 365 * 24 * 3600 * 1000, // Максимальный диапазон - 1 год
                    startOnTick: true,
                    endOnTick: true,
                    showFirstLabel: true,
                    showLastLabel: true
                }],
                yAxis: {
                    uniqueNames: true,
                    grid: {
                        enabled: true,
                        borderColor: gridColor,
                        borderWidth: 1
                    },
                    labels: {
                        style: { color: textColor, fontSize: '13px', fontWeight: '500' }
                    },
                    // Настройки для touch
                    minPadding: 0.05,
                    maxPadding: 0.05
                },
                tooltip: {
                    pointFormat: '<span>{point.name}</span><br/>' +
                        'Начало: <b>{point.start:%e %b}</b><br/>' +
                        'Конец: <b>{point.end:%e %b}</b>',
                    style: { fontSize: '12px' },
                    // Оптимизация для touch
                    touch: {
                        enabled: true,
                        hideDelay: 300
                    }
                },
                plotOptions: {
                    series: {
                        animation: { duration: 800 },
                        dataLabels: {
                            enabled: true,
                            format: '{point.name}',
                            style: {
                                color: 'white',
                                textOutline: 'none',
                                fontWeight: 'normal',
                                fontSize: '11px'
                            }
                        },
                        // Включаем touch-события для серий
                        point: {
                            events: {
                                // Добавляем поддержку touch
                                click: function(e) {
                                    // Обработка касания
                                    if (e.point) {
                                        console.log('Touched point:', e.point.name);
                                    }
                                }
                            }
                        }
                    }
                },
                series: [{
                    name: config.projectName,
                    data: ganttData,
                    // Оптимизация для мобильных устройств
                    turboThreshold: 1000,
                    boostThreshold: 1000
                }],
                navigator: { 
                    enabled: true,
                    // Настройки для мобильных
                    handles: {
                        backgroundColor: '#f2f2f2',
                        borderColor: '#999'
                    },
                    margin: 30,
                    outlineWidth: 1,
                    outlineColor: '#ddd'
                },
                scrollbar: { 
                    enabled: true,
                    // Увеличиваем область касания для мобильных
                    barBackgroundColor: '#e6e6e6',
                    barBorderRadius: 4,
                    buttonBorderRadius: 4,
                    rifleColor: '#666',
                    trackBackgroundColor: '#f2f2f2',
                    trackBorderRadius: 4
                },
                rangeSelector: {
                    enabled: true,
                    buttons: [
                        { type: 'month', count: 1, text: '1 мес' },
                        { type: 'month', count: 3, text: '3 мес' },
                        { type: 'all', text: 'Все' }
                    ],
                    selected: 2,
                    // Настройки для мобильных
                    buttonTheme: {
                        width: 60,
                        padding: 8,
                        style: {
                            fontSize: '12px',
                            fontWeight: 'normal'
                        },
                        states: {
                            hover: {
                                backgroundColor: '#f0f0f0'
                            },
                            select: {
                                backgroundColor: '#0D47A1',
                                color: 'white'
                            }
                        }
                    },
                    inputPosition: {
                        align: 'right',
                        y: 0
                    },
                    inputStyle: {
                        fontSize: '14px',
                        padding: '4px',
                        color: '#333'
                    }
                },
                credits: { enabled: false },
                // Глобальные настройки для touch
                accessibility: {
                    enabled: true,
                    screenReaderSection: {
                        beforeChartFormat: ''
                    }
                }
            });

            // Добавляем обработчики touch-событий для контейнера
            const chartContainer = document.getElementById('ganttChart');
            if (chartContainer) {
                chartContainer.addEventListener('touchstart', function(e) {
                    // Предотвращаем стандартное поведение только если это не мультитач
                    if (e.touches.length > 1) {
                        e.preventDefault(); // Разрешаем пинч-зум
                    }
                }, { passive: false });

                chartContainer.addEventListener('touchmove', function(e) {
                    if (e.touches.length > 1) {
                        e.preventDefault(); // Разрешаем пинч-зум при движении
                    }
                }, { passive: false });

                chartContainer.addEventListener('touchend', function(e) {
                    // Сбрасываем состояние при окончании касания
                });
            }
        }

        // Функция для проверки мобильного устройства
        function isMobileDevice() {
            return (typeof window.orientation !== "undefined") || 
                   (navigator.userAgent.indexOf('IEMobile') !== -1) ||
                   (/Android|webOS|iPhone|iPad|iPod|BlackBerry|BB|PlayBook|IEMobile|Windows Phone|Kindle|Silk|Opera Mini/i.test(navigator.userAgent));
        }

        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Применяем настройки для мобильных устройств
            if (isMobileDevice()) {
                // Увеличиваем область касания для мобильных
                const style = document.createElement('style');
                style.textContent = `
                    .highcharts-handle {
                        width: 16px !important;
                        height: 16px !important;
                    }
                    .highcharts-range-selector-buttons button {
                        padding: 10px !important;
                        min-width: 70px !important;
                    }
                    .highcharts-scrollbar {
                        height: 20px !important;
                    }
                    .highcharts-scrollbar-button {
                        width: 20px !important;
                    }
                `;
                document.head.appendChild(style);
            }
            
            updateChart();
        });
        
        // Автоматический ресайз при изменении размера окна
        window.addEventListener('resize', () => {
            if(chartInstance) {
                chartInstance.reflow();
            }
        });

        // Слушатель для получения данных (если будет использоваться как модалка)
        window.addEventListener('message', function(event) {
             if (event.data.type === 'UPDATE_DATA') {
                 // Если родительское окно передаст новые данные
                 if(event.data.projectData) {
                     projectData = event.data.projectData;
                 }
                 if(event.data.projectName) {
                     config.projectName = event.data.projectName;
                 }
                 updateChart();
             }
        });
    </script>
</body>
</html>
